{% extends "base.html" %}

{% block title %}{{ subject.subject_code }} - {{ subject.course_level }}{{ subject.section }} Attendance{% endblock title %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/instructor/subject_attendance.css') }}">
{% endblock %}

{% block content %}
  <script>
    // Warn before reload
    window.onbeforeunload = function() {
      return "Do not reload this page. Attendance data might not be stored.";
    };
  </script>

  <h2>{{ subject.subject_code }} - {{ subject.course_level }}{{ subject.section }} Attendance</h2>
  <div class="alert" style="background-color: #ffeb3b; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
    ‚ö†Ô∏è <strong>Warning:</strong> This page is waiting for fingerprint data. Do not reload. Attendance will be recorded once a fingerprint is scanned.
  </div>

  <div class="table-container">
    <table class="attendance-table">
      <thead>
        <tr>
          <th>Last Name</th>
          <th>First Name</th>
          <th>Middle Name</th>
          <th>Time In</th>
          <th>Marked</th>
        </tr>
      </thead>
      <tbody id="attendance-body">
        {% for student in attendance_list %}
        <tr>
          <td>{{ student.last_name }}</td>
          <td>{{ student.first_name }}</td>
          <td>{{ student.middle_name }}</td>
          <td>{{ student.time_in }}</td>
          <td>
            {% if student.mark == 'check' %}
              <span class="mark-check">‚úÖ Present</span>
            {% elif student.mark == 'late' %}
              <span class="mark-late">üïí Late</span>
            {% else %}
              <span class="mark-absent">‚ùå Absent</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    // Polling every 3 seconds to refresh attendance list
    setInterval(() => {
      fetch(location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newTbody = doc.querySelector('#attendance-body');
          document.querySelector('#attendance-body').innerHTML = newTbody.innerHTML;
        });
    }, 3000);
  </script>
{% endblock %}
